<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Лабиринт Башни Дюны</title>
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      background: #222;
      color: #eee;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 10px;
    }
    h1, h2 {
      text-align: center;
    }
    /* Контейнер для лабиринта */
    #maze-container {
      display: grid;
      grid-template-columns: repeat(15, 30px);
      grid-auto-rows: 30px;
      gap: 0;
      border: 2px solid #eee;
      margin-bottom: 10px;
    }
    .cell {
      width: 30px;
      height: 30px;
      box-sizing: border-box;
      position: relative;
    }
    /* Рисуем стены ячейки */
    .wall-top   { border-top: 2px solid #eee; }
    .wall-right { border-right: 2px solid #eee; }
    .wall-bottom{ border-bottom: 2px solid #eee; }
    .wall-left  { border-left: 2px solid #eee; }
    /* Игрок */
    .player {
      background: #ff6600;
    }
    /* Пометка ячейки с загадкой (если не решена) */
    .puzzle {
      background: #444;
    }
    .puzzle::after {
      content: "?";
      position: absolute;
      top: 0;
      right: 0;
      font-size: 16px;
      color: #ff6600;
    }
    /* Финальная ячейка – дверь главного зала */
    .final {
      background: #0055aa;
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
    }
    /* Информация игрока */
    #info {
      margin-bottom: 10px;
    }
    /* Кнопки управления */
    #controls button {
      padding: 5px 10px;
      margin: 2px;
      font-size: 16px;
      cursor: pointer;
    }
    /* Модальное окно */
    #modal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    #modal-content {
      background: #333;
      padding: 20px;
      max-width: 400px;
      text-align: center;
      border-radius: 5px;
    }
    #modal input[type="text"] {
      padding: 5px;
      margin: 10px;
      width: 80%;
    }
    #restartBtn {
      margin-top: 10px;
      padding: 5px 10px;
    }
  </style>
</head>
<body>
  <h1>Лабиринт Башни Дюны</h1>
  <div id="info">
    <span>Ключей: <span id="keysCount">0</span>/3</span>
  </div>
  <div id="maze-container"></div>
  <div id="controls">
    <button onclick="movePlayer('up')">↑</button><br>
    <button onclick="movePlayer('left')">←</button>
    <button onclick="movePlayer('right')">→</button><br>
    <button onclick="movePlayer('down')">↓</button>
  </div>

  <!-- Модальное окно для загадок и финала -->
  <div id="modal">
    <div id="modal-content"></div>
  </div>

  <script>
    // Размеры лабиринта
    const mazeWidth = 15;
    const mazeHeight = 15;
    const cellSize = 30; // для отрисовки
    let maze = [];
    let player = { x: 0, y: 0, keys: 0 };
    // Для финального выбора – случайно назначаем безопасную дверь (0 или 1)
    let safeDoor = Math.random() < 0.5 ? 0 : 1;

    const mazeContainer = document.getElementById("maze-container");
    const keysCountEl = document.getElementById("keysCount");
    const modal = document.getElementById("modal");
    const modalContent = document.getElementById("modal-content");

    // Генерация лабиринта с помощью алгоритма "backtracking"
    function generateMaze() {
      // Инициализируем ячейки
      for (let y = 0; y < mazeHeight; y++) {
        maze[y] = [];
        for (let x = 0; x < mazeWidth; x++) {
          maze[y][x] = {
            x, y,
            walls: { top: true, right: true, bottom: true, left: true },
            visited: false,
            puzzle: false,  // загадочная комната
            solved: false   // была ли загадка решена
          };
        }
      }
      // Рекурсивный алгоритм обхода
      let stack = [];
      let current = maze[0][0];
      current.visited = true;

      while (true) {
        let neighbors = getUnvisitedNeighbors(current);
        if (neighbors.length > 0) {
          let next = neighbors[Math.floor(Math.random() * neighbors.length)];
          removeWalls(current, next);
          stack.push(current);
          next.visited = true;
          current = next;
        } else if (stack.length > 0) {
          current = stack.pop();
        } else {
          break;
        }
      }
      // Размечаем случайным образом комнаты с загадками (но не старт и не финальную)
      for (let y = 0; y < mazeHeight; y++) {
        for (let x = 0; x < mazeWidth; x++) {
          if ((x !== 0 || y !== 0) && (x !== mazeWidth-1 || y !== mazeHeight-1)) {
            if (Math.random() < 0.2) {  // 20% шанс
              maze[y][x].puzzle = true;
            }
          }
        }
      }
    }

    // Функция поиска непосещённых соседей
    function getUnvisitedNeighbors(cell) {
      let neighbors = [];
      let { x, y } = cell;
      // Верх
      if (y > 0 && !maze[y - 1][x].visited) neighbors.push(maze[y - 1][x]);
      // Право
      if (x < mazeWidth - 1 && !maze[y][x + 1].visited) neighbors.push(maze[y][x + 1]);
      // Низ
      if (y < mazeHeight - 1 && !maze[y + 1][x].visited) neighbors.push(maze[y + 1][x]);
      // Лево
      if (x > 0 && !maze[y][x - 1].visited) neighbors.push(maze[y][x - 1]);
      return neighbors;
    }

    // Удаление стен между текущей и выбранной ячейкой
    function removeWalls(current, next) {
      let xDiff = current.x - next.x;
      let yDiff = current.y - next.y;
      if (xDiff === 1) {
        current.walls.left = false;
        next.walls.right = false;
      } else if (xDiff === -1) {
        current.walls.right = false;
        next.walls.left = false;
      }
      if (yDiff === 1) {
        current.walls.top = false;
        next.walls.bottom = false;
      } else if (yDiff === -1) {
        current.walls.bottom = false;
        next.walls.top = false;
      }
    }

    // Отрисовка лабиринта
    function renderMaze() {
      mazeContainer.innerHTML = "";
      for (let y = 0; y < mazeHeight; y++) {
        for (let x = 0; x < mazeWidth; x++) {
          const cell = maze[y][x];
          const cellDiv = document.createElement("div");
          cellDiv.classList.add("cell");
          // Добавляем классы для стен
          if (cell.walls.top) cellDiv.classList.add("wall-top");
          if (cell.walls.right) cellDiv.classList.add("wall-right");
          if (cell.walls.bottom) cellDiv.classList.add("wall-bottom");
          if (cell.walls.left) cellDiv.classList.add("wall-left");

          // Если в ячейке есть загадка и не решена, подсвечиваем её
          if (cell.puzzle && !cell.solved) {
            cellDiv.classList.add("puzzle");
          }
          // Финальная ячейка (главный зал)
          if (x === mazeWidth - 1 && y === mazeHeight - 1) {
            cellDiv.classList.add("final");
            cellDiv.innerText = "Дверь";
          }
          // Пометка игрока
          if (player.x === x && player.y === y) {
            cellDiv.classList.add("player");
          }
          cellDiv.id = `cell-${x}-${y}`;
          mazeContainer.appendChild(cellDiv);
        }
      }
    }

    // Обновление отрисовки игрока и лабиринта
    function updateMaze() {
      renderMaze();
      keysCountEl.innerText = player.keys;
      checkCurrentCell();
    }

    // Логика движения игрока – учитываем стены текущей ячейки
    function movePlayer(direction) {
      let cx = player.x, cy = player.y;
      let cell = maze[cy][cx];
      if (direction === "up" && !cell.walls.top) {
        player.y--;
      } else if (direction === "down" && !cell.walls.bottom) {
        player.y++;
      } else if (direction === "left" && !cell.walls.left) {
        player.x--;
      } else if (direction === "right" && !cell.walls.right) {
        player.x++;
      }
      updateMaze();
    }

    // Проверка, что находится в текущей ячейке
    function checkCurrentCell() {
      let cell = maze[player.y][player.x];
      // Если ячейка содержит загадку и она не решена, запускаем её
      if (cell.puzzle && !cell.solved) {
        triggerPuzzle(cell);
      }
      // Если игрок попал в финальную ячейку
      if (player.x === mazeWidth - 1 && player.y === mazeHeight - 1) {
        if (player.keys >= 3) {
          triggerFinalDoor();
        } else {
          showModal(`<p>Дверь заблокирована. Соберите 3 ключа, чтобы открыть главный зал.</p>
          <button onclick="closeModal()">Закрыть</button>`);
        }
      }
    }

    // Модальное окно – загадка
    function triggerPuzzle(cell) {
      // Загадка: назовите предмет, который открывает двери.
      let html = `<h2>Загадка</h2>
        <p>Назовите предмет, который открывает двери.</p>
        <input type="text" id="puzzleAnswer" placeholder="Ваш ответ">
        <br>
        <button onclick="checkPuzzle(${cell.x},${cell.y})">Ответить</button>
        <button onclick="closeModal()">Отмена</button>`;
      showModal(html);
    }

    // Проверка ответа загадки
    function checkPuzzle(x, y) {
      const answer = document.getElementById("puzzleAnswer").value.trim().toLowerCase();
      if (answer === "ключ") {
        maze[y][x].solved = true;
        player.keys++;
        showModal(`<p>Правильно! Вы получили Ключ.</p>
        <button onclick="closeModal()">Продолжить</button>`);
      } else {
        showModal(`<p>Неправильный ответ. Попробуйте позже.</p>
        <button onclick="closeModal()">Закрыть</button>`);
      }
      updateMaze();
    }

    // Модальное окно для финальной двери
    function triggerFinalDoor() {
      let html = `<h2>Главный зал</h2>
        <p>Перед вами две двери. Одна из них безопасна, другая – смертельна.</p>
        <p>Выберите дверь:</p>
        <button onclick="chooseFinalDoor(0)">Дверь 1</button>
        <button onclick="chooseFinalDoor(1)">Дверь 2</button>`;
      showModal(html);
    }

    function chooseFinalDoor(choice) {
      if (choice === safeDoor) {
        showModal(`<h2>Победа!</h2>
          <p>Вы выбрали правильную дверь и вышли на свободу!</p>
          <button onclick="restartGame()">Начать заново</button>`);
      } else {
        showModal(`<h2>Поражение</h2>
          <p>Неверный выбор! Эта дверь оказалась смертельной.</p>
          <button onclick="restartGame()">Начать заново</button>`);
      }
    }

    // Функции работы с модальным окном
    function showModal(content) {
      modalContent.innerHTML = content;
      modal.style.display = "flex";
    }
    function closeModal() {
      modal.style.display = "none";
    }
    function restartGame() {
      location.reload();
    }

    // Инициализация игры
    function init() {
      generateMaze();
      renderMaze();
    }
    init();
  </script>
</body>
</html>
