<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Лабиринт Башни Дюны</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #222;
      color: #eee;
    }
    /* Общие стили для экранов */
    .screen { display: none; padding: 20px; }
    .active { display: block; }
    h1, h2, h3 { text-align: center; }
    button { padding: 10px 15px; margin: 5px; cursor: pointer; }
    /* Стили для выбора персонажа */
    #character-selection { text-align: center; }
    .character-btn {
      background: #444;
      border: none;
      color: #fff;
      font-size: 16px;
      margin: 10px;
      padding: 15px 20px;
      border-radius: 5px;
    }
    .character-btn:hover {
      background: #555;
    }
    /* Игровой экран */
    #game-container {
      max-width: 600px;
      margin: 0 auto;
    }
    #stats {
      text-align: center;
      margin-bottom: 10px;
    }
    #game-board {
      display: grid;
      grid-template-columns: repeat(7, 50px);
      grid-gap: 2px;
      margin: 10px auto;
      background: #333;
      padding: 5px;
    }
    .cell {
      width: 50px;
      height: 50px;
      background: #666;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      border: 1px solid #555;
      position: relative;
    }
    .cell.player {
      background: #ff6600;
      color: #000;
      font-weight: bold;
    }
    /* Управление стрелками */
    #controls {
      text-align: center;
      margin-top: 10px;
    }
    #controls button { font-size: 16px; }
    /* Модальное окно для событий */
    #modal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 1000;
    }
    #modal-content {
      background: #333;
      padding: 20px;
      max-width: 500px;
      margin: 100px auto;
      border-radius: 5px;
      text-align: center;
    }
  </style>
</head>
<body>
  <!-- Экран выбора персонажа -->
  <div id="character-selection" class="screen active">
    <h1>Выберите персонажа</h1>
    <p>Каждый персонаж имеет свой радиус перемещения за ход:</p>
    <button class="character-btn" onclick="chooseCharacter('Вахаиб', 6)">Вахаиб (6 клеток)</button>
    <button class="character-btn" onclick="chooseCharacter('Гнилион', 8)">Гнилион (8 клеток)</button>
    <button class="character-btn" onclick="chooseCharacter('Офилнекр', 5)">Офилнекр (5 клеток)</button>
    <button class="character-btn" onclick="chooseCharacter('Залупатор', 5)">Залупатор (5 клеток)</button>
  </div>

  <!-- Игровой экран -->
  <div id="game-container" class="screen">
    <h2>Лабиринт Башни Дюны</h2>
    <div id="stats">
      Здоровье: <span id="health">10</span> | Очков перемещения: <span id="movesLeft"></span>
    </div>
    <div id="game-board"></div>
    <div id="controls">
      <button onclick="movePlayer('up')">↑ Вверх</button><br>
      <button onclick="movePlayer('left')">← Влево</button>
      <button onclick="movePlayer('right')">Вправо →</button><br>
      <button onclick="movePlayer('down')">↓ Вниз</button>
    </div>
  </div>

  <!-- Модальное окно для мини-игр -->
  <div id="modal">
    <div id="modal-content"></div>
  </div>

  <script>
    // Глобальные переменные игры
    const gridSize = 7;
    let player = { name: '', moveRange: 0, movesLeft: 0, x: 0, y: 0, health: 10, mutantAlly: false };
    // Определяем события на клетках (координаты в формате "x,y")
    let events = {
      "1,1": { type: "codeLock" },
      "0,3": { type: "fallingDebris" },
      "3,1": { type: "shadowMaze" },
      "4,2": { type: "sandTrap" },
      "5,4": { type: "mutantCapsule" },
      "2,2": { type: "secretPassage" },
      "3,3": { type: "finalDoor" }
    };

    // Элементы интерфейса
    const charScreen = document.getElementById('character-selection');
    const gameScreen = document.getElementById('game-container');
    const boardEl = document.getElementById('game-board');
    const healthEl = document.getElementById('health');
    const movesEl = document.getElementById('movesLeft');
    const modal = document.getElementById('modal');
    const modalContent = document.getElementById('modal-content');

    // Создаем игровое поле
    let cells = [];
    function initBoard() {
      boardEl.innerHTML = '';
      cells = [];
      for (let y = 0; y < gridSize; y++) {
        for (let x = 0; x < gridSize; x++) {
          const cell = document.createElement('div');
          cell.classList.add('cell');
          cell.dataset.x = x;
          cell.dataset.y = y;
          // Можно для отладки выводить координаты
          // cell.innerText = `${x},${y}`;
          boardEl.appendChild(cell);
          cells.push(cell);
        }
      }
      updatePlayerPosition();
    }

    // Обновление клетки с игроком
    function updatePlayerPosition() {
      cells.forEach(cell => cell.classList.remove('player'));
      const index = player.y * gridSize + player.x;
      cells[index].classList.add('player');
      movesEl.innerText = player.movesLeft;
      healthEl.innerText = player.health;
    }

    // Функция выбора персонажа
    function chooseCharacter(name, moveRange) {
      player.name = name;
      player.moveRange = moveRange;
      player.movesLeft = moveRange;
      // Начальная позиция (например, верхний левый угол)
      player.x = 0;
      player.y = 0;
      charScreen.classList.remove('active');
      gameScreen.classList.add('active');
      initBoard();
    }

    // Функция перемещения игрока
    function movePlayer(direction) {
      if (player.movesLeft <= 0) {
        // Если очки перемещения закончились, начинаем новый ход
        player.movesLeft = player.moveRange;
      }
      let newX = player.x, newY = player.y;
      if (direction === 'up') newY--;
      if (direction === 'down') newY++;
      if (direction === 'left') newX--;
      if (direction === 'right') newX++;
      // Проверяем границы
      if (newX < 0 || newX >= gridSize || newY < 0 || newY >= gridSize) return;
      player.x = newX;
      player.y = newY;
      player.movesLeft--;
      updatePlayerPosition();
      checkForEvent();
    }

    // Проверяем, есть ли событие на новой клетке
    function checkForEvent() {
      const key = player.x + ',' + player.y;
      if (events[key]) {
        const eventData = events[key];
        // Убираем событие, чтобы оно не повторялось
        delete events[key];
        triggerEvent(eventData.type);
      }
    }

    // Функция показа модального окна
    function showModal(content) {
      modalContent.innerHTML = content;
      modal.style.display = 'block';
    }
    function hideModal() {
      modal.style.display = 'none';
    }

    // Обработка событий по типу
    function triggerEvent(type) {
      switch(type) {
        case "codeLock":
          handleCodeLock();
          break;
        case "fallingDebris":
          handleFallingDebris();
          break;
        case "shadowMaze":
          handleShadowMaze();
          break;
        case "sandTrap":
          handleSandTrap();
          break;
        case "mutantCapsule":
          handleMutantCapsule();
          break;
        case "secretPassage":
          handleSecretPassage();
          break;
        case "finalDoor":
          handleFinalDoor();
          break;
        default:
          break;
      }
    }

    /* 1. Кодовый замок (Запертые ворота) */
    let codeLockInput = [];
    function handleCodeLock() {
      codeLockInput = [];
      let html = `<h3>Запертые ворота - Кодовый замок</h3>
        <p>В пустыне выживает тот, кто следует пути стихий.<br>Введите последовательность: Песок, Ветер, Вода, Солнце.</p>
        <div id="codeLockDisplay">Введено: </div>`;
      // Кнопки для ввода
      ["Песок", "Ветер", "Вода", "Солнце"].forEach(item => {
        html += `<button onclick="codeLockChoose('${item}')">${item}</button> `;
      });
      showModal(html);
    }
    function codeLockChoose(choice) {
      codeLockInput.push(choice);
      document.getElementById("codeLockDisplay").innerText = "Введено: " + codeLockInput.join(", ");
      if (codeLockInput.length === 4) {
        // Проверяем последовательность
        const correct = ["Песок", "Ветер", "Вода", "Солнце"];
        if (JSON.stringify(codeLockInput) === JSON.stringify(correct)) {
          showModal("<p>Верно! Дверь открывается.</p><button onclick='closeEvent()'>Продолжить</button>");
        } else {
          player.health -= 2;
          showModal("<p>Неправильно! Включена тревога, атакуют стражники.</p><button onclick='closeEvent()'>Продолжить</button>");
        }
      }
    }

    /* 2. Обвалившийся коридор (Проверка ловкости) */
    let debrisTimeout;
    function handleFallingDebris() {
      let html = `<h3>Обвалившийся коридор - Проверка ловкости</h3>
        <p>Нажмите кнопку "Перепрыгнуть" до истечения 3 секунд!</p>
        <button id="jumpBtn" onclick="jumpSuccess()">Перепрыгнуть</button>`;
      showModal(html);
      debrisTimeout = setTimeout(() => {
        player.health -= 2;
        showModal("<p>Не успели! Вы получили урон от завала.</p><button onclick='closeEvent()'>Продолжить</button>");
      }, 3000);
    }
    function jumpSuccess() {
      clearTimeout(debrisTimeout);
      showModal("<p>Успех! Вы перепрыгнули через обвал.</p><button onclick='closeEvent()'>Продолжить</button>");
    }

    /* 3. Оптический коридор (Лабиринт теней) */
    function handleShadowMaze() {
      let html = `<h3>Оптический коридор - Лабиринт теней</h3>
        <p>Иди туда, где нет света, но есть путь.<br>Выберите дверь:</p>
        <button onclick="shadowMazeChoose(1)">Дверь 1</button>
        <button onclick="shadowMazeChoose(2)">Дверь 2</button>
        <button onclick="shadowMazeChoose(3)">Дверь 3</button>`;
      showModal(html);
    }
    function shadowMazeChoose(num) {
      if (num === 2) {
        showModal("<p>Правильно! Ты нашёл верный путь.</p><button onclick='closeEvent()'>Продолжить</button>");
      } else {
        player.health -= 2;
        showModal("<p>Неверно! Ты получил урон.</p><button onclick='closeEvent()'>Продолжить</button>");
      }
    }

    /* 4. Песчаная ловушка (Выживание) */
    function handleSandTrap() {
      let html = `<h3>Песчаная ловушка - Выживание</h3>
        <p>Ты начинаешь тонуть в песке. Выбери действие:</p>
        <button onclick="sandTrapChoose('Двигаться быстро')">Двигаться быстро</button>
        <button onclick="sandTrapChoose('Расслабиться и замереть')">Расслабиться и замереть</button>
        <button onclick="sandTrapChoose('Применить предмет (крюк/верёвка)')">Применить предмет (крюк/верёвка)</button>`;
      showModal(html);
    }
    function sandTrapChoose(choice) {
      if (choice === 'Применить предмет (крюк/верёвка)') {
        showModal("<p>Верно! Ты выбрал правильное действие.</p><button onclick='closeEvent()'>Продолжить</button>");
      } else {
        player.health -= 1;
        showModal("<p>Неверный выбор! Ты получил урон и теряешь ход.</p><button onclick='closeEvent()'>Продолжить</button>");
      }
    }

    /* 5. Капсула с мутантом (Выбор судьбы) */
    function handleMutantCapsule() {
      let html = `<h3>Капсула с мутантом - Выбор судьбы</h3>
        <p>Объект: Дельта-7.<br>Что ты сделаешь?</p>
        <button onclick="mutantCapsuleChoose('open')">Открыть капсулу</button>
        <button onclick="mutantCapsuleChoose('block')">Заблокировать</button>`;
      showModal(html);
    }
    function mutantCapsuleChoose(choice) {
      if (choice === 'open') {
        player.health -= 1;
        player.mutantAlly = true;
        showModal("<p>Ты открыл капсулу. Существо атакует, но впоследствии помогает тебе.</p><button onclick='closeEvent()'>Продолжить</button>");
      } else {
        showModal("<p>Ты заблокировал капсулу. Путь продолжается без изменений.</p><button onclick='closeEvent()'>Продолжить</button>");
      }
    }

    /* 6. Тайный проход (Комбинация кнопок) */
    let secretInput = [];
    function handleSecretPassage() {
      secretInput = [];
      let html = `<h3>Тайный проход - Комбинация кнопок</h3>
        <p>Найди правильную последовательность.<br>Кнопки: A, B, C<br>(Подсказка: правильная последовательность: B, A, C)</p>
        <div id="secretDisplay">Введено: </div>`;
      ["A", "B", "C"].forEach(letter => {
        html += `<button onclick="secretChoose('${letter}')">${letter}</button> `;
      });
      showModal(html);
    }
    function secretChoose(letter) {
      secretInput.push(letter);
      document.getElementById("secretDisplay").innerText = "Введено: " + secretInput.join(", ");
      if (secretInput.length === 3) {
        const correct = ["B", "A", "C"];
        if (JSON.stringify(secretInput) === JSON.stringify(correct)) {
          showModal("<p>Верно! Тайный проход открыт.</p><button onclick='closeEvent()'>Продолжить</button>");
        } else {
          player.health -= 1;
          showModal("<p>Неверно! Ты получил урон.</p><button onclick='closeEvent()'>Продолжить</button>");
        }
      }
    }

    /* 7. Финальная дверь (Вход в зал Садора Крайвиса) */
    function handleFinalDoor() {
      let html = `<h3>Финальная дверь</h3>
        <p>Тот, кто правит пустыней, не оставляет следов. Тот, кто жаждет крови, оставляет лишь пыль.<br>Выбери:</p>
        <button onclick="finalDoorChoose('Ветер')">Ветер</button>
        <button onclick="finalDoorChoose('Кровь')">Кровь</button>`;
      showModal(html);
    }
    function finalDoorChoose(choice) {
      if (choice === 'Ветер') {
        showModal("<p>Поздравляем! Дверь открыта, и ты побеждаешь в финальной битве!</p><button onclick='endGame(true)'>Завершить игру</button>");
      } else {
        showModal("<p>Ловушка! Атака лазеров. Игра окончена.</p><button onclick='endGame(false)'>Завершить игру</button>");
      }
    }

    // Завершение события: скрываем модальное окно и обновляем состояние игры.
    function closeEvent() {
      hideModal();
      updatePlayerPosition();
      checkGameOver();
    }
    
    // Проверка на окончание игры (если здоровье упало до 0 или ниже)
    function checkGameOver() {
      if (player.health <= 0) {
        showModal("<p>Твое здоровье закончилось. Игра окончена.</p><button onclick='location.reload()'>Начать заново</button>");
      }
    }
    
    // Завершение игры (победа/поражение)
    function endGame(victory) {
      if (victory) {
        showModal("<h3>Победа!</h3><p>Ты прошёл лабиринт Башни Дюны.</p><button onclick='location.reload()'>Начать заново</button>");
      } else {
        showModal("<h3>Поражение</h3><p>Ты не справился с финальным испытанием.</p><button onclick='location.reload()'>Начать заново</button>");
      }
    }
  </script>
</body>
</html>
